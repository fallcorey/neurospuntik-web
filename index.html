<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroSputnik üß† - CORS Fixed</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; height: 100vh; overflow: hidden;
        }
        .app-container { height: 100vh; display: flex; flex-direction: column; }
        .header { text-align: center; padding: 20px; background: rgba(0,0,0,0.2); }
        .status-bar { padding: 10px; text-align: center; font-size: 0.9em; }
        .status-connected { background: rgba(76,175,80,0.3); }
        .status-warning { background: rgba(255,193,7,0.3); }
        .status-error { background: rgba(255,100,100,0.3); }
        .messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
        .message { max-width: 85%; padding: 12px; border-radius: 18px; font-size: 0.95em; line-height: 1.4; }
        .user-message { align-self: flex-end; background: rgba(255,255,255,0.9); color: #333; }
        .neuro-message { align-self: flex-start; background: rgba(255,255,255,0.15); }
        .input-area { padding: 15px; background: rgba(0,0,0,0.2); display: flex; gap: 10px; }
        #messageInput { flex: 1; padding: 12px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 25px; color: white; }
        .send-btn { padding: 12px 20px; background: linear-gradient(45deg, #FF6B6B, #4ECDC4); border: none; border-radius: 25px; color: white; font-weight: bold; cursor: pointer; }
        .fix-section { padding: 15px; background: rgba(0,0,0,0.3); border-top: 2px solid rgba(255,255,255,0.2); }
        .fix-btn { width: 100%; padding: 12px; margin: 5px 0; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); border-radius: 10px; color: white; cursor: pointer; }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <h1>üß† NeuroSputnik</h1>
            <p>Ollama –ø–æ–¥–∫–ª—é—á–µ–Ω! CORS –∏—Å–ø—Ä–∞–≤–ª—è–µ–º...</p>
        </div>

        <div class="status-bar" id="statusBar">
            üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...
        </div>

        <div class="messages" id="messages">
            <div class="message neuro-message">
                <strong>NeuroSputnik:</strong> –í–∏–∂—É —á—Ç–æ Ollama –∑–∞–ø—É—â–µ–Ω! –ò—Å–ø—Ä–∞–≤–ª—è—é CORS –ø—Ä–æ–±–ª–µ–º—É... ‚ö°
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="messageInput" placeholder="–ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å...">
            <button class="send-btn" id="sendBtn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>

        <div class="fix-section">
            <button class="fix-btn" onclick="fixCors()">üîß –ò—Å–ø—Ä–∞–≤–∏—Ç—å CORS –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏</button>
            <button class="fix-btn" onclick="showCorsCommands()">üíª –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è CORS</button>
            <button class="fix-btn" onclick="useProxy()">üîÑ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–æ–∫—Å–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS</button>
        </div>
    </div>

    <script>
        class CorsFixedOllama {
            constructor() {
                this.baseUrl = 'http://localhost:11434';
                this.proxyUrl = ''; // –ë—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CORS –ø—Ä–æ–∫—Å–∏ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
                this.isConnected = false;
                this.models = [];
            }

            async connect() {
                // –ü—Ä–æ–±—É–µ–º –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                try {
                    const response = await this.directFetch('/api/tags');
                    if (response.ok) {
                        const data = await response.json();
                        this.models = data.models || [];
                        this.isConnected = true;
                        return true;
                    }
                } catch (error) {
                    console.log('–ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å:', error);
                }

                // –ü—Ä–æ–±—É–µ–º —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏
                return await this.tryWithProxy();
            }

            async directFetch(endpoint) {
                return fetch(`${this.baseUrl}${endpoint}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    mode: 'cors'
                });
            }

            async tryWithProxy() {
                // –ü—Ä–æ–±—É–µ–º —Ä–∞–∑–Ω—ã–µ CORS –ø—Ä–æ–∫—Å–∏
                const proxies = [
                    `https://cors-anywhere.herokuapp.com/${this.baseUrl}`,
                    `https://api.codetabs.com/v1/proxy?quest=${this.baseUrl}`,
                    `https://corsproxy.io/?${encodeURIComponent(this.baseUrl)}`
                ];

                for (const proxy of proxies) {
                    try {
                        const response = await fetch(`${proxy}/api/tags`);
                        if (response.ok) {
                            const data = await response.json();
                            this.models = data.models || [];
                            this.proxyUrl = proxy;
                            this.isConnected = true;
                            return true;
                        }
                    } catch (error) {
                        console.log(`–ü—Ä–æ–∫—Å–∏ ${proxy} –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª`);
                    }
                }
                return false;
            }

            async sendMessage(message) {
                if (!this.isConnected) {
                    return this.getSmartResponse(message);
                }

                try {
                    let response;
                    if (this.proxyUrl) {
                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏
                        response = await fetch(`${this.proxyUrl}/api/generate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                model: this.models[0]?.name || 'llama2',
                                prompt: `–¢—ã - NeuroSputnik. –û—Ç–≤–µ—á–∞–π –ø–æ–ª–µ–∑–Ω–æ.\n\n–í–æ–ø—Ä–æ—Å: ${message}\n\n–û—Ç–≤–µ—Ç:`,
                                stream: false
                            })
                        });
                    } else {
                        // –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
                        response = await fetch(`${this.baseUrl}/api/generate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            mode: 'cors',
                            body: JSON.stringify({
                                model: this.models[0]?.name || 'llama2',
                                prompt: `–¢—ã - NeuroSputnik. –û—Ç–≤–µ—á–∞–π –ø–æ–ª–µ–∑–Ω–æ.\n\n–í–æ–ø—Ä–æ—Å: ${message}\n\n–û—Ç–≤–µ—Ç:`,
                                stream: false
                            })
                        });
                    }

                    const data = await response.json();
                    return `ü§ñ [Ollama]: ${data.response}`;
                } catch (error) {
                    return this.getSmartResponse(message);
                }
            }

            getSmartResponse(message) {
                return `üéØ "${message}" - —Ö–æ—Ä–æ—à–∏–π –≤–æ–ø—Ä–æ—Å!

Ollama –∑–∞–ø—É—â–µ–Ω, –Ω–æ –µ—Å—Ç—å CORS –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è. 

‚úÖ –ß—Ç–æ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
‚Ä¢ Ollama —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç 11434
‚Ä¢ –ú–æ–¥–µ–ª—å Llama2 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
‚Ä¢ API –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å—ã

üîß –ß—Ç–æ –¥–µ–ª–∞–µ–º:
1. –ò—Å–ø—Ä–∞–≤–ª—è–µ–º CORS –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
2. –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–∫—Å–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞
3. –ò–ª–∏ —Ä–∞–±–æ—Ç–∞–µ–º –≤ —É–º–Ω–æ–º —Ä–µ–∂–∏–º–µ

–ü—Ä–æ–¥–æ–ª–∂–∞–π –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã! üí´`;
            }
        }

        class NeuroApp {
            constructor() {
                this.ollama = new CorsFixedOllama();
                this.init();
            }

            async init() {
                this.setupEventListeners();
                await this.checkConnection();
            }

            setupEventListeners() {
                document.getElementById('sendBtn').addEventListener('click', () => {
                    this.sendMessage();
                });

                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
            }

            async checkConnection() {
                const statusBar = document.getElementById('statusBar');
                
                statusBar.textContent = 'üîÑ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ Ollama...';
                statusBar.className = 'status-bar status-warning';

                const connected = await this.ollama.connect();

                if (connected) {
                    if (this.ollama.proxyUrl) {
                        statusBar.textContent = '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏! CORS –æ–±–æ–π–¥–µ–Ω!';
                    } else {
                        statusBar.textContent = '‚úÖ –ü—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ! CORS –∏—Å–ø—Ä–∞–≤–ª–µ–Ω!';
                    }
                    statusBar.className = 'status-bar status-connected';
                    
                    this.addMessage(`üéâ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! –ú–æ–¥–µ–ª–µ–π: ${this.ollama.models.length}`, 'neuro');
                } else {
                    statusBar.textContent = '‚ö†Ô∏è CORS –±–ª–æ–∫–∏—Ä—É–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ. –ò—Å–ø–æ–ª—å–∑—É–π –∫–Ω–æ–ø–∫–∏ –Ω–∏–∂–µ.';
                    statusBar.className = 'status-bar status-error';
                }
            }

            async sendMessage() {
                const input = document.getElementById('messageInput');
                const message = input.value.trim();
                if (!message) return;

                this.addMessage(message, 'user');
                input.value = '';

                const response = await this.ollama.sendMessage(message);
                this.addMessage(response, 'neuro');
            }

            addMessage(text, type) {
                const messagesDiv = document.getElementById('messages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}-message`;
                messageDiv.innerHTML = `<strong>${type === 'user' ? '–í—ã' : 'NeuroSputnik'}:</strong> ${text}`;
                messagesDiv.appendChild(messageDiv);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function fixCors() {
            const commands = `üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï CORS - –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ç–µ—Ä–º–∏–Ω–∞–ª–∞:

1. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Ollama:
   sudo systemctl stop ollama
   pkill ollama

2. –ó–∞–ø—É—Å–∫–∞–µ–º —Å CORS —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ–º:
   OLLAMA_ORIGINS="*" OLLAMA_HOST=0.0.0.0 ollama serve &

3. –ü—Ä–æ–≤–µ—Ä—è–µ–º:
   curl http://localhost:11434/api/tags

4. –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É NeuroSputnik!`;

            alert(commands);
        }

        function showCorsCommands() {
            const commands = `üíª –ü–û–°–¢–û–Ø–ù–ù–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï CORS:

–°–æ–∑–¥–∞–µ–º —Å–µ—Ä–≤–∏—Å —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏:

sudo tee /etc/systemd/system/ollama.service << 'EOF'
[Unit]
Description=Ollama AI Server
After=network.target

[Service]
Type=simple
User=alex
Environment=OLLAMA_ORIGINS="*"
Environment=OLLAMA_HOST=0.0.0.0
ExecStart=/usr/local/bin/ollama serve
Restart=always

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable ollama
sudo systemctl start ollama`;

            alert(commands);
        }

        function useProxy() {
            app.addMessage('üîÑ –ê–∫—Ç–∏–≤–∏—Ä—É—é –æ–±—Ö–æ–¥ CORS —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏...', 'neuro');
            setTimeout(() => {
                app.checkConnection();
            }, 1000);
        }

        const app = new NeuroApp();
    </script>
</body>
</html>
